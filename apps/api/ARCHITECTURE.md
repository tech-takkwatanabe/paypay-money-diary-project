# apps/api アーキテクチャ

## 概要

`apps/api` は、クリーンアーキテクチャの原則に基づいて設計された RESTful API サーバーです。
Hono フレームワークと OpenAPI (Zod-OpenAPI) を使用し、型安全かつドキュメント化された API を提供します。

## アーキテクチャ構造

依存関係は常に内側（Domain層）に向かう単方向のみとなります。

```
┌─────────────────────────────────────────────────────────┐
│  Controller層 (HTTP I/O、OpenAPI定義)                   │
│  - リクエストのバリデーション (Zod)                      │
│  - ルーティング定義 (OpenAPIHono)                        │
│  - Entity → DTO 変換                                     │
└────────────────────┬────────────────────────────────────┘
                     │ 依存
                     ↓
┌─────────────────────────────────────────────────────────┐
│  Usecase層 (アプリケーションサービス)                    │
│  - ビジネスフローの制御                                  │
│  - トランザクション管理                                  │
│  - 複数 Service/Repository の組み合わせ                  │
└────────────────────┬────────────────────────────────────┘
                     │ 依存
                     ↓
┌─────────────────────────────────────────────────────────┐
│  Service層 (ドメインサービス)                            │
│  - 状態を持たないビジネスロジック                        │
│  - エンティティに閉じない計算や検証                      │
└────────────────────┬────────────────────────────────────┘
                     │ 依存
                     ↓
┌─────────────────────────────────────────────────────────┐
│  Domain層 (ドメインモデル)                               │
│  - Entity: 識別子を持つドメインオブジェクト              │
│  - Repository Interface: データアクセスの抽象化          │
│  - ValueObject: 不変の値オブジェクト                     │
└─────────────────────────────────────────────────────────┘
                     ↑ 実装
┌─────────────────────────────────────────────────────────┐
│  Infrastructure層 (技術的詳細)                           │
│  - Repository実装 (Drizzle ORM / Redis)                  │
│  - 外部ライブラリ (JWT, bcrypt, etc.)                    │
└─────────────────────────────────────────────────────────┘
```

## ディレクトリ構造

```
apps/api/src/
├── controller/      # Controller層: ルート定義とハンドラー
├── usecase/         # Usecase層: アプリケーション固有のロジック
├── service/         # Service層: ドメインビジネスロジック
├── domain/          # Domain層: エンティティとリポジトリ界面
├── infrastructure/  # Infrastructure層: DB実装や外部連携
├── middleware/      # Hono ミドルウェア (認証など)
├── db/              # データベース接続とスキーマ定義 (Drizzle)
├── types/           # アプリケーション共通の型定義
├── lib/             # 共通ユーティリティ
└── index.ts         # エントリーポイント
```

## 各層の詳細

### Controller層 (`src/controller/`)
- `*.routes.ts`: OpenAPI 仕様に基づいたエンドポイントの定義。
- `*Controller.ts`: HTTP リクエストを受け取り、Usecase を呼び出し、結果を DTO に変換して返却。

### Usecase層 (`src/usecase/`)
- 1つのファイルに1つのユースケース（例: `CreateTransactionUseCase`）を記述。
- 外部（Controller）から受け取ったプリミティブな値をドメインオブジェクトに変換し、ロジックを実行。

### Service層 (`src/service/`)
- エンティティ単体では表現できないビジネスルールを実装。
- 例: `CsvService` (CSVのパースとカテゴリの自動割り当てロジック)。

### Domain層 (`src/domain/`)
- `entity/`: ビジネスルールをカプセル化したクラス。
- `repository/`: インフラ層に実装を強制するインターフェース。

### Infrastructure層 (`src/infrastructure/`)
- データベース (PostgreSQL/Drizzle) やキャッシュ (Redis) への具体的なアクセスを実装。
- 外部サービスやライブラリとの統合。

### Middleware (`src/middleware/`)
- 認証 (`authMiddleware`) など、リクエストの前処理を行う共通コンポーネント。

## 型安全性の確保

- **Zod**: リクエスト/レスポンスのバリデーションに使用。
- **OpenAPI**: `hono/zod-openapi` を使用して、コードから自動的に OpenAPI ドキュメントを生成。
- **Shared Package**: フロントエンドとバックエンドでバリデーションスキーマ (`@paypay-money-diary/shared`) を共有。
